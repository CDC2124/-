import streamlit as st
import pandas as pd
import os
import sys

# 页面配置
st.set_page_config(
    page_title="使用说明 - 生产需求系统",
    page_icon="📚",
    layout="wide"
)

# 页面标题
st.title("生产需求系统使用说明")

st.markdown("""
## 系统概述

本系统是一个基于历史出货数据进行月度销售预测、生产计划制定和原材料需求计划生成的集成解决方案，旨在提高生产规划的准确性和效率。

### 核心功能

1. **数据分析**：处理和分析历史出货数据，识别销售趋势和模式
2. **销售预测**：利用多种预测算法生成月度销售预测，支持交互式调整
3. **生产计划**：基于Google OR-Tools优化引擎生成最优生产计划
4. **物料需求计划(MRP)**：结合BOM清单和生产计划，计算原材料需求，生成采购计划
5. **预测分析报告**：自动对比预测与实际销售数据，生成分析报告以持续改进预测精度

### 技术特点

- **多算法预测**：支持ARIMA、指数平滑、移动平均等多种预测方法
- **优化求解**：使用Google OR-Tools求解库实现复杂优化问题
- **交互式界面**：基于Streamlit开发直观易用的交互界面
- **可视化分析**：丰富的图表展示和数据可视化
- **本地数据存储**：所有数据和结果保存在本地电脑，保证数据安全
""")

# 使用流程
st.header("使用流程")

st.markdown("""
### 1. 数据上传与分析

**功能**：上传并分析历史出货数据，为后续预测做准备。

**操作步骤**：
1. 准备历史出货数据（CSV或Excel格式）
2. 上传数据文件
3. 系统自动处理和验证数据
4. 查看数据分析结果和趋势图表

### 2. 销售预测

**功能**：基于历史数据生成月度销售预测。

**操作步骤**：
1. 设置预测参数（预测期数、预测方法等）
2. 生成预测并查看结果
3. 根据业务知识调整预测值（可选）
4. 导出预测结果

### 3. 生产计划

**功能**：基于销售预测或销售订单生成优化的生产计划。

**操作步骤**：
1. 加载销售预测数据或上传销售订单
2. 设置库存数据和产能约束
3. 配置优化目标和约束参数
4. 生成优化生产计划
5. 根据需要调整计划（系统自动重新计算库存）
6. 导出生产计划

### 4. 物料清单(BOM)管理

**功能**：管理产品的物料清单(BOM)结构。

**操作步骤**：
1. 上传BOM数据文件
2. 系统自动验证BOM结构
3. 查看和管理BOM层级关系

### 5. 原材料需求计划(MRP)

**功能**：结合生产计划和BOM生成原材料需求计划。

**操作步骤**：
1. 加载生产计划和BOM数据
2. 设置库存数据和供应商信息
3. 配置MRP计算参数
4. 计算原材料需求和生成采购计划
5. 查看计算结果和可视化图表
6. 导出采购计划和MRP报告

### 6. 预测分析报告

**功能**：对比预测与实际销售数据，生成分析报告。

**操作步骤**：
1. 上传预测数据和实际销售数据
2. 设置报告期和关键产品
3. 生成分析报告
4. 查看预测准确率、偏差分析和趋势图表
5. 导出Excel或PDF格式报告
""")

# 数据格式要求
st.header("数据格式要求")

with st.expander("历史出货数据格式"):
    st.markdown("""
    历史出货数据需包含以下字段：

    | 字段名称 | 说明 | 数据类型 | 是否必需 |
    |---------|------|---------|---------|
    | 类型 | 订单类型 | 文本 | 是 |
    | number | 订单编号 | 文本或数字 | 是 |
    | 销售订单号 | 销售系统中的订单号 | 文本 | 是 |
    | 销售请求日期 | 客户请求的销售日期 | 日期 (YYYY-MM-DD) | 是 |
    | 仓库实际日期 | 实际出货日期 | 日期 (YYYY-MM-DD) | 是 |
    | 客户编号 | 客户的唯一标识码 | 文本 | 是 |
    | 客户组 | 客户所属的分组 | 文本 | 是 |
    | 销售员 | 负责该订单的销售人员 | 文本 | 是 |
    | 客服 | 负责该订单的客服人员 | 文本 | 是 |
    | 物料编号 | 产品/物料的唯一编码 | 文本 | 是 |
    | 自由文本 | 订单相关的备注信息 | 文本 | 是 |
    | 批次数量 | 出货数量 | 数字 | 是 |
    """)

with st.expander("物料清单(BOM)格式"):
    st.markdown("""
    物料清单(BOM)数据需包含以下字段：

    | 字段名称 | 说明 | 数据类型 | 是否必需 |
    |---------|------|---------|---------|
    | 成品编号 | 成品的物料编号 | 文本 | 是 |
    | 成品描述 | 成品的描述 | 文本 | 否 |
    | 子件编号 | 组成成品的子件编号 | 文本 | 是 |
    | 子件描述 | 子件的描述 | 文本 | 否 |
    | 单位用量 | 每单位成品需要的子件数量 | 数字 | 是 |
    | 单位 | 计量单位 | 文本 | 否 |
    | 损耗率(%) | 生产过程中的损耗比例 | 数字 | 否 |
    | 备注 | 其他信息 | 文本 | 否 |

    **注意**: 系统支持多级BOM结构：
    - 成品可以由基础原料直接构成
    - 成品也可以由基础原料和半成品共同构成
    - 半成品应由基础原料构成
    """)

with st.expander("库存数据格式"):
    st.markdown("""
    库存数据需包含以下字段：

    | 字段名称 | 说明 | 数据类型 | 是否必需 |
    |---------|------|---------|---------|
    | 物料编号 | 物料的唯一编码 | 文本 | 是 |
    | 库存数量 | 当前库存数量 | 数字 | 是 |
    | 物料描述 | 物料的描述 | 文本 | 否 |
    | 库存地点 | 存储位置 | 文本 | 否 |
    """)

with st.expander("销售订单数据格式"):
    st.markdown("""
    销售订单数据需包含以下字段：

    | 字段名称 | 说明 | 数据类型 | 是否必需 |
    |---------|------|---------|---------|
    | 物料编号 | 物料的唯一编码 | 文本 | 是 |
    | 订单数量 |.订单的数量 | 数字 | 是 |
    | 要求交期 | 交货日期 | 日期 (YYYY-MM-DD) | 是 |
    | 客户编号 | 客户标识 | 文本 | 否 |
    | 订单号 | 销售订单号 | 文本 | 否 |
    """)

# 系统配置要求
st.header("系统配置要求")

st.markdown("""
### 最低系统要求

- **操作系统**: Windows 10/11, macOS 10.15+, Linux
- **处理器**: 双核处理器, 2.0GHz+
- **内存**: 8GB RAM
- **存储空间**: 500MB可用空间
- **Python版本**: 3.8或更高

### 依赖库

系统依赖以下主要Python库:

- streamlit: 用于Web界面
- pandas, numpy: 用于数据处理
- matplotlib, plotly, seaborn: 用于数据可视化
- statsmodels: 用于时间序列预测
- ortools: 用于优化计算
- openpyxl, xlsxwriter: 用于Excel文件处理

可以通过以下命令安装所有依赖:

```bash
pip install -r requirements.txt
```
""")

# 常见问题
st.header("常见问题")

with st.expander("系统支持哪些预测算法?"):
    st.markdown("""
    本系统支持以下预测算法:
    
    1. **ARIMA模型**: 适合有明显趋势和季节性的产品
    2. **指数平滑法**: 适合短期预测和数据较少的产品
    3. **移动平均法**: 适合稳定型产品
    
    系统可以自动为每种产品选择最合适的算法，也可以手动指定使用哪种算法。
    """)

with st.expander("如何调整优化目标?"):
    st.markdown("""
    在生产计划页面的"约束设置"标签页中，您可以选择以下优化目标:
    
    1. **最小化成本**: 优化生产成本和库存成本
    2. **最大化生产平滑**: 减少生产量的波动
    3. **最小化库存**: 尽量减少库存水平
    
    选择不同的优化目标会导致不同的生产计划结果。
    """)

with st.expander("如何处理销售订单"):
    st.markdown("""
    系统支持两种方式生成生产计划:
    
    1. **基于预测**: 使用历史出货数据生成的销售预测
    2. **基于订单**: 使用实际销售订单
    
    在生产计划页面的"数据准备"标签页中，选择"使用销售订单"并上传订单数据即可。系统将自动处理订单数据并转换为生产计划可用的格式。
    """)

with st.expander("如何评估预测准确性?"):
    st.markdown("""
    在预测分析报告页面，系统提供了全面的预测评估功能:
    
    1. **各产品的预测vs实际对比**: 详细展示每个产品的预测值、实际值和偏差
    2. **预测准确率计算**: 按产品类别和整体统计预测准确率
    3. **偏差分析**: 识别预测偏差最大的产品及可能原因
    4. **趋势图表**: 直观展示预测和实际值的变化趋势
    5. **模型调整建议**: 基于历史偏差模式提供模型调整建议
    
    系统每月自动生成分析报告，帮助持续改进预测模型。
    """)

# 功能导航
st.header("功能导航")

col1, col2 = st.columns(2)

with col1:
    st.subheader("主要功能模块")
    
    st.markdown("""
    - **[数据上传与分析](数据上传与分析)**: 上传并分析历史出货数据
    - **[销售预测](销售预测)**: 生成月度销售预测
    - **[生产计划](生产计划)**: 优化生产计划
    - **[原材料需求计划](原材料需求计划)**: 计算物料需求
    - **[预测分析报告](预测分析报告)**: 分析预测准确性
    """)

with col2:
    st.subheader("快速入门")
    
    st.info("**初次使用推荐流程**")
    
    st.markdown("""
    1. 准备历史出货数据和BOM数据
    2. 上传历史数据并分析
    3. 生成销售预测
    4. 制定生产计划
    5. 计算物料需求和采购计划
    6. 导出结果用于实际生产
    7. 月末生成预测分析报告，评估预测准确性
    """)

# 联系与支持
st.header("联系与支持")

st.markdown("""
如有任何问题或需要技术支持，请联系:

📧 prodplanning@example.com

或在系统GitHub仓库提交Issue:
🔗 [GitHub仓库](https://github.com/example/production-planning-system)
""")

# 页脚
st.markdown("---")
st.markdown("© 2025 生产需求系统 | 版本 1.0.0 | 基于Streamlit和OR-Tools开发")